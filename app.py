import streamlit as st
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from langchain_core.output_parsers import StrOutputParser
from dotenv import load_dotenv
import os
import streamlit.components.v1 as components

# --- ì´ˆê¸° ì„¤ì • ---

# .env íŒŒì¼ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ (íŒŒì¼ì´ ìˆëŠ” ê²½ìš°)
load_dotenv()

# Streamlit í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="êµì‹¤ì˜ ì˜¨ë„", page_icon="ğŸŒ¡ï¸", layout="wide")

# ì„¸ì…˜ ìƒíƒœ ì´ˆê¸°í™”
if 'generated_texts' not in st.session_state:
    st.session_state.generated_texts = {}


# --- CSS ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ---
st.markdown("""
<style>
    /* ì „ì²´ ì•±ì˜ í°íŠ¸ */
    html, body, [class*="st-"] {
        font-family: 'Pretendard', sans-serif;
    }
    /* í˜ì´ì§€ ì œëª© */
    h1 {
        font-weight: 800;
        color: #0068c9;
    }
    /* íƒ­ ìŠ¤íƒ€ì¼ */
    button[data-baseweb="tab"] {
        font-size: 18px;
        font-weight: 700;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
    }
    button[data-baseweb="tab"]:not([aria-selected="true"]):hover {
        background-color: #f0f2f6;
        color: #0068c9;
    }
    button[data-baseweb="tab"][aria-selected="true"] {
        background-color: #FFFFFF;
        color: #0068c9;
        border-bottom: 3px solid #0068c9;
    }
    /* ìƒì„± ë²„íŠ¼ */
    .stButton>button {
        font-weight: 700;
        border-radius: 8px;
    }
    /* ì»¨í…Œì´ë„ˆ ë³´ë” */
    [data-testid="stVerticalBlock"] > [data-testid="stVerticalBlock"] > [data-testid="stVerticalBlock"] > [data-testid="stExpander"] [data-testid="stHeader"] {
        font-weight: 700;
    }
</style>
""", unsafe_allow_html=True)

# --- ì—”ì§„ ì„¤ì • (í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿) ---

PROMPTS = {
    # 1-1. ê³„íš ìˆ˜ë¦½
    "plan": ChatPromptTemplate.from_template("""
        ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ì´ˆÂ·ì¤‘í•™êµì˜ í–‰ì • ì—…ë¬´ì— ëŠ¥ìˆ™í•œ êµì‚¬ì…ë‹ˆë‹¤. 'ê°ì¢… ê³„íš ìˆ˜ë¦½'ì„ ìœ„í•œ ë‚´ë¶€ê²°ì¬ìš© ê¸°ì•ˆë¬¸ ì´ˆì•ˆì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
        ì•„ë˜ [ê³µë¬¸ ì‘ì„± ê·œì¹™], [ì‘ì„± ê·œì¹™]ê³¼ [ì˜ˆì‹œ]ë¥¼ ì°¸ê³ í•˜ì—¬, ì‚¬ìš©ìê°€ ì…ë ¥í•œ [ê¸°ì•ˆ ë‚´ìš©]ì„ ë°”íƒ•ìœ¼ë¡œ ì™„ë²½í•˜ê³  ê°„ê²°í•œ ê¸°ì•ˆë¬¸ì„ ìƒì„±í•´ ì£¼ì„¸ìš”.
        
        **ì¤‘ìš”ì‚¬í•­:**
        - ì¶œë ¥ ì‹œ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš” (**, *, #, -, ``` ë“± ê¸ˆì§€)
        - ëª¨ë“  ê°•ì¡°ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ í‘œí˜„í•˜ì„¸ìš”
        - ë°˜ë“œì‹œ '1. ê´€ë ¨:' í•­ëª©ë¶€í„° ì‹œì‘í•˜ì„¸ìš”
        - ìˆœìˆ˜í•œ ê³µë¬¸ì„œ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”

        [ê³µë¬¸ ì‘ì„± ê·œì¹™]
        - ê´€ë ¨ ê·¼ê±° (ì²« ë²ˆì§¸ í•­ëª©): ê¸°ì•ˆì˜ ë²•ì , í–‰ì •ì  ê·¼ê±°ê°€ ë˜ëŠ” ìƒìœ„ ê³µë¬¸ì„œë‚˜ ë²•ê·œë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
        - ë³¸ë¬¸ ë‚´ìš©: "ë‹¤ìŒê³¼ ê°™ì´", "ì•„ë˜ì™€ ê°™ì´" ë“±ì˜ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì‹œì‘í•˜ë©°, ìœ¡í•˜ì›ì¹™ì— ë”°ë¼ ëª…í™•í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
        - í•­ëª© êµ¬ë¶„: 1., ê°€., 1), ê°€), (1), (ê°€), â‘ , ã‰® ìˆœìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        - ì •ë ¬: ì²«ì§¸ í•­ëª©(1., 2., ...)ì€ ì™¼ìª½ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê³ , ë‘˜ì§¸ í•­ëª©(ê°€., ë‚˜., ...)ë¶€í„°ëŠ” ì˜¤ë¥¸ìª½ìœ¼ë¡œ 2íƒ€ì”© ì˜®ê²¨ ì‹œì‘í•©ë‹ˆë‹¤.
        - ê¸ˆì•¡ í‘œê¸°: ê¸ˆ123,450ì›(ê¸ˆì¼ì‹­ì´ë§Œì‚¼ì²œì‚¬ë°±ì˜¤ì‹­ì›)ê³¼ ê°™ì´ ì•„ë¼ë¹„ì•„ ìˆ«ìì™€ í•œê¸€ì„ ë³‘ê¸°í•©ë‹ˆë‹¤.
        - ë‚ ì§œ í‘œê¸°: 2025. 8. 1.(ê¸ˆ) 14:00ì™€ ê°™ì´ í‘œê¸°í•©ë‹ˆë‹¤.
        - ê²°ë¬¸: ë³¸ë¬¸ ë‚´ìš©ì´ ëë‚˜ë©´ í•œ ê¸€ì(2íƒ€)ë¥¼ ë„ìš°ê³  "ë."ì´ë¼ê³  í‘œì‹œí•©ë‹ˆë‹¤. ì²¨ë¶€ë¬¼ì´ ìˆì„ ê²½ìš°, ë¶™ì„ í‘œì‹œë¬¸ ë‹¤ìŒì— í•œ ê¸€ìë¥¼ ë„ìš°ê³  "ë."ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        - ë¶™ì„: ì²¨ë¶€ íŒŒì¼ì´ 2ê°œ ì´ìƒì´ë©´ ê° íŒŒì¼ëª…ì— ë²ˆí˜¸ë¥¼ ë¶™ì—¬ ë‚˜ì—´í•˜ê³ , ê° íŒŒì¼ëª… ëì— ìˆ˜ëŸ‰ì„ í‘œê¸°í•©ë‹ˆë‹¤.

        [ì‘ì„± ê·œì¹™]
        1. ì œëª©: 'OOOO ê³„íš(ì•ˆ)' í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
        2. ê´€ë ¨: ì œì‹œëœ ê´€ë ¨ ê·¼ê±°ë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
        3. ëª©ì : ê¸°ì•ˆì˜ ëª©ì ì„ ëª…í™•í•˜ê²Œ ì„œìˆ í•©ë‹ˆë‹¤.
        4. ì„¸ë¶€ ê³„íš: 'ê°€, ë‚˜, ë‹¤' í•­ëª©ì„ ì‚¬ìš©í•˜ì—¬ ì¼ì‹œ, ì¥ì†Œ, ëŒ€ìƒ, ì˜ˆì‚° ë“±ì„ ì²´ê³„ì ìœ¼ë¡œ ê¸°ìˆ í•©ë‹ˆë‹¤.
        5. ë¶™ì„: ë¶™ì„ ë¬¸ì„œ ëª©ë¡ì„ ì •í™•íˆ ê¸°ì¬í•˜ê³ , ëª©ë¡ ëì— '1ë¶€.'ì™€ ê°™ì´ ìˆ˜ëŸ‰ì„ í‘œê¸°í•œ í›„, ì „ì²´ ë¬¸ì„œì˜ ë§ˆì§€ë§‰ì€ 'ë.'ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.

        [ì˜ˆì‹œ]
        1. ê´€ë ¨: 2025í•™ë…„ë„ í•™êµêµìœ¡ê³„íš
        2. ìœ„ í˜¸ì™€ ê´€ë ¨í•˜ì—¬ 2025í•™ë…„ë„ í˜„ì¥ì²´í—˜í•™ìŠµì„ ë‹¤ìŒê³¼ ê°™ì´ ì‹¤ì‹œí•˜ê³ ì í•©ë‹ˆë‹¤.
          ê°€. ì¼ì‹œ: 2025. 10. 15. (ìˆ˜) 09:00 ~ 15:00
          ë‚˜. ì¥ì†Œ: OO ë¯¼ì†ì´Œ
          ë‹¤. ëŒ€ìƒ: 5í•™ë…„ í•™ìƒ ì „ì²´ (120ëª…) ë° ì¸ì†”êµì‚¬ 6ëª…
          ë¼. ì˜ˆì‚°: ê¸ˆ1,200,000ì› (ê¸ˆì¼ë°±ì´ì‹­ë§Œì›) - ìˆ˜ìµì ë¶€ë‹´ ê²½ë¹„
        ë¶™ì„  1. í˜„ì¥ì²´í—˜í•™ìŠµ ì„¸ë¶€ ì¼ì • 1ë¶€.
              2. í˜„ì¥ì²´í—˜í•™ìŠµ ì•ˆì „ ê´€ë¦¬ ê³„íš 1ë¶€. ë.
        ---
        [ê¸°ì•ˆ ë‚´ìš©]
        - ê³„íšëª…: {plan_name}
        - ê´€ë ¨ ê·¼ê±°: {related_basis}
        - ëª©ì : {purpose}
        - ì„¸ë¶€ ê³„íš: {details}
        - ë¶™ì„ ë¬¸ì„œ: {attachments}
        ---"""),

    # 1-2. ì˜ˆì‚° ì§‘í–‰(í’ˆì˜)
    "budget": ChatPromptTemplate.from_template("""
        ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ì´ˆÂ·ì¤‘í•™êµì˜ í–‰ì • ì—…ë¬´ì— ëŠ¥ìˆ™í•œ êµì‚¬ì…ë‹ˆë‹¤. 'ì˜ˆì‚° ì§‘í–‰(í’ˆì˜)'ì„ ìœ„í•œ ë‚´ë¶€ê²°ì¬ìš© ê¸°ì•ˆë¬¸ ì´ˆì•ˆì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
        ì•„ë˜ [ê³µë¬¸ ì‘ì„± ê·œì¹™], [ì‘ì„± ê·œì¹™]ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•˜ì—¬, ì‚¬ìš©ìê°€ ì…ë ¥í•œ [í’ˆì˜ ë‚´ìš©]ì„ ë°”íƒ•ìœ¼ë¡œ ì™„ë²½í•œ í’ˆì˜ì„œë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.
        
        **ì¤‘ìš”ì‚¬í•­:**
        - ì¶œë ¥ ì‹œ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš” (**, *, #, -, ``` ë“± ê¸ˆì§€)
        - ëª¨ë“  ê°•ì¡°ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ í‘œí˜„í•˜ì„¸ìš”
        - ë°˜ë“œì‹œ '1. ê´€ë ¨:' í•­ëª©ë¶€í„° ì‹œì‘í•˜ì„¸ìš”
        - ìˆœìˆ˜í•œ ê³µë¬¸ì„œ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”

        [ê³µë¬¸ ì‘ì„± ê·œì¹™]
        - ê´€ë ¨ ê·¼ê±° (ì²« ë²ˆì§¸ í•­ëª©): ê¸°ì•ˆì˜ ë²•ì , í–‰ì •ì  ê·¼ê±°ê°€ ë˜ëŠ” ìƒìœ„ ê³µë¬¸ì„œë‚˜ ë²•ê·œë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
        - ë³¸ë¬¸ ë‚´ìš©: "ë‹¤ìŒê³¼ ê°™ì´", "ì•„ë˜ì™€ ê°™ì´" ë“±ì˜ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì‹œì‘í•˜ë©°, ìœ¡í•˜ì›ì¹™ì— ë”°ë¼ ëª…í™•í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
        - í•­ëª© êµ¬ë¶„: 1., ê°€., 1), ê°€), (1), (ê°€), â‘ , ã‰® ìˆœìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        - ì •ë ¬: ì²«ì§¸ í•­ëª©(1., 2., ...)ì€ ì™¼ìª½ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê³ , ë‘˜ì§¸ í•­ëª©(ê°€., ë‚˜., ...)ë¶€í„°ëŠ” ì˜¤ë¥¸ìª½ìœ¼ë¡œ 2íƒ€ì”© ì˜®ê²¨ ì‹œì‘í•©ë‹ˆë‹¤.
        - ê¸ˆì•¡ í‘œê¸°: ê¸ˆ123,450ì›(ê¸ˆì¼ì‹­ì´ë§Œì‚¼ì²œì‚¬ë°±ì˜¤ì‹­ì›)ê³¼ ê°™ì´ ì•„ë¼ë¹„ì•„ ìˆ«ìì™€ í•œê¸€ì„ ë³‘ê¸°í•©ë‹ˆë‹¤.
        - ë‚ ì§œ í‘œê¸°: 2025. 8. 1.(ê¸ˆ) 14:00ì™€ ê°™ì´ í‘œê¸°í•©ë‹ˆë‹¤.
        - ê²°ë¬¸: ë³¸ë¬¸ ë‚´ìš©ì´ ëë‚˜ë©´ í•œ ê¸€ì(2íƒ€)ë¥¼ ë„ìš°ê³  "ë."ì´ë¼ê³  í‘œì‹œí•©ë‹ˆë‹¤. ì²¨ë¶€ë¬¼ì´ ìˆì„ ê²½ìš°, ë¶™ì„ í‘œì‹œë¬¸ ë‹¤ìŒì— í•œ ê¸€ìë¥¼ ë„ìš°ê³  "ë."ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        - ë¶™ì„: ì²¨ë¶€ íŒŒì¼ì´ 2ê°œ ì´ìƒì´ë©´ ê° íŒŒì¼ëª…ì— ë²ˆí˜¸ë¥¼ ë¶™ì—¬ ë‚˜ì—´í•˜ê³ , ê° íŒŒì¼ëª… ëì— ìˆ˜ëŸ‰ì„ í‘œê¸°í•©ë‹ˆë‹¤.

        [ì‘ì„± ê·œì¹™]
        1. ì œëª©: 'OOOOì„(ë¥¼) ìœ„í•œ ë¬¼í’ˆ êµ¬ì… í’ˆì˜' ë˜ëŠ” 'OOOO ê´€ë ¨ ê²½ë¹„ ì§€ì¶œ í’ˆì˜' í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
        2. ê´€ë ¨: ì˜ˆì‚° ê´€ë ¨ ê·¼ê±°ë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
        3. ëª©ì : ì§€ì¶œ ëª©ì ì„ ëª…í™•íˆ ì„œìˆ í•©ë‹ˆë‹¤.
        4. êµ¬ì…(ì§€ì¶œ) ë‚´ì—­: í•­ëª©í™”í•˜ì—¬ ìƒì„¸íˆ ê¸°ìˆ í•©ë‹ˆë‹¤.
        5. ì†Œìš” ì˜ˆì‚°: **ê°€ì¥ ì¤‘ìš”.** ì…ë ¥ëœ ìˆ«ì ì˜ˆì‚°ì„ 'ê¸ˆOOOì›(ê¸ˆOOOì›ì •)' í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ê¸°ì¬í•©ë‹ˆë‹¤. ì˜ˆ) 150000 -> ê¸ˆ150,000ì›(ê¸ˆì¼ì‹­ì˜¤ë§Œì›ì •).
        6. ì˜ˆì‚° ê³¼ëª©: ì œì‹œëœ ì˜ˆì‚° ê³¼ëª©ì„ ì •í™•íˆ ê¸°ì¬í•©ë‹ˆë‹¤.
        7. ë¶™ì„: ë¶™ì„ ë¬¸ì„œ ëª©ë¡ì„ ì •í™•íˆ ê¸°ì¬í•˜ê³ , 'ë.'ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.
        ---
        [í’ˆì˜ ë‚´ìš©]
        - í’ˆì˜ ì œëª©: {purchase_title}
        - ê´€ë ¨ ê·¼ê±°: {related_basis}
        - ëª©ì : {purpose}
        - ìƒì„¸ ë‚´ì—­: {details}
        - ì†Œìš” ì˜ˆì‚° (ìˆ«ì): {budget_amount}
        - ì˜ˆì‚° ê³¼ëª©: {budget_subject}
        - ë¶™ì„ ë¬¸ì„œ: {attachments}
        ---"""),

    # (ì‹ ê·œ) 2-1. ìë£Œ ì œì¶œ
    "submission": ChatPromptTemplate.from_template("""
        ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ì´ˆÂ·ì¤‘í•™êµì˜ í–‰ì • ì „ë¬¸ê°€ì…ë‹ˆë‹¤. ìƒê¸‰ ê¸°ê´€(êµìœ¡ì²­ ë“±)ì— 'ìë£Œë¥¼ ì œì¶œ'í•˜ê¸° ìœ„í•œ ëŒ€ì™¸ë°œì†¡ìš© ì‹œí–‰ë¬¸ ì´ˆì•ˆì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
        [ê³µë¬¸ ì‘ì„± ê·œì¹™], [ì‘ì„± ê·œì¹™]ê³¼ [ì˜ˆì‹œ]ë¥¼ ì°¸ê³ í•˜ì—¬, ì‚¬ìš©ìê°€ ì…ë ¥í•œ [ì œì¶œ ë‚´ìš©]ìœ¼ë¡œ ì™„ë²½í•œ ì‹œí–‰ë¬¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
        
        **ì¤‘ìš”ì‚¬í•­:**
        - ì¶œë ¥ ì‹œ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš” (**, *, #, -, ``` ë“± ê¸ˆì§€)
        - ëª¨ë“  ê°•ì¡°ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ í‘œí˜„í•˜ì„¸ìš”
        - ë°˜ë“œì‹œ 'ìˆ˜ì‹ ì:' í•­ëª©ë¶€í„° ì‹œì‘í•˜ì„¸ìš”
        - ìˆœìˆ˜í•œ ê³µë¬¸ì„œ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”

        [ê³µë¬¸ ì‘ì„± ê·œì¹™]
        - ê´€ë ¨ ê·¼ê±° (ì²« ë²ˆì§¸ í•­ëª©): ê¸°ì•ˆì˜ ë²•ì , í–‰ì •ì  ê·¼ê±°ê°€ ë˜ëŠ” ìƒìœ„ ê³µë¬¸ì„œë‚˜ ë²•ê·œë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
        - ë³¸ë¬¸ ë‚´ìš©: "ë‹¤ìŒê³¼ ê°™ì´", "ì•„ë˜ì™€ ê°™ì´" ë“±ì˜ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì‹œì‘í•˜ë©°, ìœ¡í•˜ì›ì¹™ì— ë”°ë¼ ëª…í™•í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
        - í•­ëª© êµ¬ë¶„: 1., ê°€., 1), ê°€), (1), (ê°€), â‘ , ã‰® ìˆœìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        - ì •ë ¬: ì²«ì§¸ í•­ëª©(1., 2., ...)ì€ ì™¼ìª½ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê³ , ë‘˜ì§¸ í•­ëª©(ê°€., ë‚˜., ...)ë¶€í„°ëŠ” ì˜¤ë¥¸ìª½ìœ¼ë¡œ 2íƒ€ì”© ì˜®ê²¨ ì‹œì‘í•©ë‹ˆë‹¤.
        - ê¸ˆì•¡ í‘œê¸°: ê¸ˆ123,450ì›(ê¸ˆì¼ì‹­ì´ë§Œì‚¼ì²œì‚¬ë°±ì˜¤ì‹­ì›)ê³¼ ê°™ì´ ì•„ë¼ë¹„ì•„ ìˆ«ìì™€ í•œê¸€ì„ ë³‘ê¸°í•©ë‹ˆë‹¤.
        - ë‚ ì§œ í‘œê¸°: 2025. 8. 1.(ê¸ˆ) 14:00ì™€ ê°™ì´ í‘œê¸°í•©ë‹ˆë‹¤.
        - ê²°ë¬¸: ë³¸ë¬¸ ë‚´ìš©ì´ ëë‚˜ë©´ í•œ ê¸€ì(2íƒ€)ë¥¼ ë„ìš°ê³  "ë."ì´ë¼ê³  í‘œì‹œí•©ë‹ˆë‹¤. ì²¨ë¶€ë¬¼ì´ ìˆì„ ê²½ìš°, ë¶™ì„ í‘œì‹œë¬¸ ë‹¤ìŒì— í•œ ê¸€ìë¥¼ ë„ìš°ê³  "ë."ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        - ë¶™ì„: ì²¨ë¶€ íŒŒì¼ì´ 2ê°œ ì´ìƒì´ë©´ ê° íŒŒì¼ëª…ì— ë²ˆí˜¸ë¥¼ ë¶™ì—¬ ë‚˜ì—´í•˜ê³ , ê° íŒŒì¼ëª… ëì— ìˆ˜ëŸ‰ì„ í‘œê¸°í•©ë‹ˆë‹¤.

        [ì‘ì„± ê·œì¹™]
        1. ìˆ˜ì‹ ì: ëª…í™•íˆ ê¸°ì¬í•©ë‹ˆë‹¤. ëª¨ë¥¼ ê²½ìš° 'ìˆ˜ì‹ ì ë¯¸ì§€ì •'ìœ¼ë¡œ ë‘¡ë‹ˆë‹¤.
        2. ì œëª©: '[ê¸°ê´€ëª…] OOO ìë£Œ ì œì¶œ' í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
        3. ë‚´ìš©: ê´€ë ¨ ê³µë¬¸ì„ 'Oë²ˆ í•­ëª©'ì—ì„œ ì–¸ê¸‰í•˜ê³ , 'ì•„ë˜ì™€ ê°™ì´' ë˜ëŠ” 'ë¶™ì„ê³¼ ê°™ì´' ìë£Œë¥¼ ì œì¶œí•¨ì„ ëª…ì‹œí•©ë‹ˆë‹¤.
        4. ë¶™ì„: ì œì¶œí•˜ëŠ” ìë£Œ ëª©ë¡ì„ ì •í™•íˆ ê¸°ì¬í•˜ê³  'ë.'ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.

        [ì˜ˆì‹œ]
        ìˆ˜ì‹ ì: OOêµìœ¡ì§€ì›ì²­ êµìœ¡ì¥
        1. ê´€ë ¨: OOêµìœ¡ì§€ì›ì²­ í•™êµìƒí™œêµìœ¡ê³¼-5678 (2025. 7. 10.)
        2. ìœ„ í˜¸ì— ì˜ê±°, ë³¸êµì˜ 2025ë…„ í•™êµí­ë ¥ ì‹¤íƒœì¡°ì‚¬ ê²°ê³¼ë¥¼ ë¶™ì„ê³¼ ê°™ì´ ì œì¶œí•©ë‹ˆë‹¤.
        ë¶™ì„  1. í•™êµí­ë ¥ ì‹¤íƒœì¡°ì‚¬ ê²°ê³¼ ë³´ê³ ì„œ 1ë¶€.
              2. ê´€ë ¨ ì„¤ë¬¸ì§€ ë° í†µê³„ ìë£Œ 1ë¶€. ë.
        ---
        [ì œì¶œ ë‚´ìš©]
        - ìˆ˜ì‹ ì: {recipient}
        - ì œì¶œí•  ìë£Œëª…: {submission_title}
        - ê´€ë ¨ ê³µë¬¸: {related_document}
        - í•™êµëª…: {school_name}
        - ë¶™ì„ ë¬¸ì„œ: {attachments}
        ---"""),

    # 2-2. ë³´ê³  ê¸°ì•ˆë¬¸
    "activity_report": ChatPromptTemplate.from_template("""
        ë‹¹ì‹ ì€ ëŒ€í•œë¯¼êµ­ ì´ˆÂ·ì¤‘í•™êµì˜ í–‰ì • ì—…ë¬´ì— ëŠ¥ìˆ™í•œ êµì‚¬ì…ë‹ˆë‹¤. 'í™œë™ ê²°ê³¼ ë³´ê³ 'ë¥¼ ìœ„í•œ ë‚´ë¶€ê²°ì¬ìš© ê¸°ì•ˆë¬¸ ì´ˆì•ˆì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
        ì•„ë˜ [ê³µë¬¸ ì‘ì„± ê·œì¹™], [ì‘ì„± ê·œì¹™]ê³¼ [ì˜ˆì‹œ]ë¥¼ ì°¸ê³ í•˜ì—¬, ì‚¬ìš©ìê°€ ì…ë ¥í•œ [ë³´ê³  ë‚´ìš©]ìœ¼ë¡œ ì™„ë²½í•œ ë³´ê³  ê¸°ì•ˆë¬¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.
        
        **ì¤‘ìš”ì‚¬í•­:**
        - ì¶œë ¥ ì‹œ ë§ˆí¬ë‹¤ìš´ ë¬¸ë²•ì„ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš” (**, *, #, -, ``` ë“± ê¸ˆì§€)
        - ëª¨ë“  ê°•ì¡°ëŠ” ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œë§Œ í‘œí˜„í•˜ì„¸ìš”
        - ë°˜ë“œì‹œ '1. ê´€ë ¨:' í•­ëª©ë¶€í„° ì‹œì‘í•˜ì„¸ìš”
        - ìˆœìˆ˜í•œ ê³µë¬¸ì„œ í˜•ì‹ìœ¼ë¡œë§Œ ì‘ì„±í•˜ì„¸ìš”

        [ê³µë¬¸ ì‘ì„± ê·œì¹™]
        - ê´€ë ¨ ê·¼ê±° (ì²« ë²ˆì§¸ í•­ëª©): ê¸°ì•ˆì˜ ë²•ì , í–‰ì •ì  ê·¼ê±°ê°€ ë˜ëŠ” ìƒìœ„ ê³µë¬¸ì„œë‚˜ ë²•ê·œë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
        - ë³¸ë¬¸ ë‚´ìš©: "ë‹¤ìŒê³¼ ê°™ì´", "ì•„ë˜ì™€ ê°™ì´" ë“±ì˜ í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì‹œì‘í•˜ë©°, ìœ¡í•˜ì›ì¹™ì— ë”°ë¼ ëª…í™•í•˜ê²Œ ì‘ì„±í•©ë‹ˆë‹¤.
        - í•­ëª© êµ¬ë¶„: 1., ê°€., 1), ê°€), (1), (ê°€), â‘ , ã‰® ìˆœìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
        - ì •ë ¬: ì²«ì§¸ í•­ëª©(1., 2., ...)ì€ ì™¼ìª½ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ê³ , ë‘˜ì§¸ í•­ëª©(ê°€., ë‚˜., ...)ë¶€í„°ëŠ” ì˜¤ë¥¸ìª½ìœ¼ë¡œ 2íƒ€ì”© ì˜®ê²¨ ì‹œì‘í•©ë‹ˆë‹¤.
        - ê¸ˆì•¡ í‘œê¸°: ê¸ˆ123,450ì›(ê¸ˆì¼ì‹­ì´ë§Œì‚¼ì²œì‚¬ë°±ì˜¤ì‹­ì›)ê³¼ ê°™ì´ ì•„ë¼ë¹„ì•„ ìˆ«ìì™€ í•œê¸€ì„ ë³‘ê¸°í•©ë‹ˆë‹¤.
        - ë‚ ì§œ í‘œê¸°: 2025. 8. 1.(ê¸ˆ) 14:00ì™€ ê°™ì´ í‘œê¸°í•©ë‹ˆë‹¤.
        - ê²°ë¬¸: ë³¸ë¬¸ ë‚´ìš©ì´ ëë‚˜ë©´ í•œ ê¸€ì(2íƒ€)ë¥¼ ë„ìš°ê³  "ë."ì´ë¼ê³  í‘œì‹œí•©ë‹ˆë‹¤. ì²¨ë¶€ë¬¼ì´ ìˆì„ ê²½ìš°, ë¶™ì„ í‘œì‹œë¬¸ ë‹¤ìŒì— í•œ ê¸€ìë¥¼ ë„ìš°ê³  "ë."ì„ í‘œì‹œí•©ë‹ˆë‹¤.
        - ë¶™ì„: ì²¨ë¶€ íŒŒì¼ì´ 2ê°œ ì´ìƒì´ë©´ ê° íŒŒì¼ëª…ì— ë²ˆí˜¸ë¥¼ ë¶™ì—¬ ë‚˜ì—´í•˜ê³ , ê° íŒŒì¼ëª… ëì— ìˆ˜ëŸ‰ì„ í‘œê¸°í•©ë‹ˆë‹¤.

        [ì‘ì„± ê·œì¹™]
        1. ì œëª©: '{activity_title} ê²°ê³¼ ë³´ê³ ' í˜•ì‹ìœ¼ë¡œ ì‘ì„±í•©ë‹ˆë‹¤.
        2. ê´€ë ¨: ê´€ë ¨ ê³„íš ë˜ëŠ” ìŠ¹ì¸ ë¬¸ì„œë¥¼ ëª…ì‹œí•©ë‹ˆë‹¤.
        3. ë³´ê³  ë‚´ìš©: 'ê°€, ë‚˜, ë‹¤, ë¼' í•­ëª©ì„ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒì„ ì²´ê³„ì ìœ¼ë¡œ ê¸°ìˆ í•©ë‹ˆë‹¤:
           - ê°€. ê°œìš” (ëª©ì , ì¼ì‹œ, ì¥ì†Œ, ì°¸ê°€ ì¸ì›)
           - ë‚˜. ì„¸ë¶€ í™œë™ ë‚´ìš© 
           - ë‹¤. ì˜ˆì‚° ì‚¬ìš© ê²°ê³¼ (í‘œ í˜•ì‹ í¬í•¨)
           - ë¼. í‰ê°€ ë° ì œì–¸
        4. ë¶™ì„: ê´€ë ¨ ìë£Œ ëª©ë¡ì„ ê¸°ì¬í•˜ê³  'ë.'ìœ¼ë¡œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.

        [ì˜ˆì‹œ]
        1. ê´€ë ¨: OOì´ˆë“±í•™êµ-1234 (2025. 4. 10.) "2025í•™ë…„ë„ í˜„ì¥ì²´í—˜í•™ìŠµ ê³„íš(ì•ˆ)"
        2. ìœ„ í˜¸ì™€ ê´€ë ¨í•˜ì—¬ í˜„ì¥ì²´í—˜í•™ìŠµì„ ì‹¤ì‹œí•œ ê²°ê³¼ë¥¼ ë‹¤ìŒê³¼ ê°™ì´ ë³´ê³ í•©ë‹ˆë‹¤.
          ê°€. ê°œìš”
              1) ëª©ì : ì—­ì‚¬ ë¬¸í™” ì²´í—˜ì„ í†µí•œ í•™ìŠµ íš¨ê³¼ ì œê³ 
              2) ì¼ì‹œ: 2025. 5. 15. (ìˆ˜) 09:00~15:00
              3) ì¥ì†Œ: ê²½ì£¼ ë¶ˆêµ­ì‚¬ ë° ì„êµ´ì•”
              4) ì°¸ê°€ ì¸ì›: í•™ìƒ 120ëª…, êµì‚¬ 8ëª…
          ë‚˜. ì„¸ë¶€ í™œë™ ë‚´ìš©
              1) ë¶ˆêµ­ì‚¬ íƒë°© ë° ë¬¸í™”ì¬ í•´ì„¤ (10:00~12:00)
              2) ì„êµ´ì•” ê²¬í•™ ë° ì²´í—˜ í™œë™ (13:00~15:00)
          ë‹¤. ì˜ˆì‚° ì‚¬ìš© ê²°ê³¼
              ì´ ì˜ˆì‚°: ê¸ˆ3,600,000ì›
              ì§€ì¶œ ë‚´ì—­: êµí†µë¹„ 2,400,000ì›, ì²´í—˜ë¹„ 1,200,000ì›
              ì”ì•¡: ê¸ˆ0ì›
          ë¼. í‰ê°€ ë° ì œì–¸
              í•™ìƒ ë§Œì¡±ë„ 95%, êµìœ¡ì  íš¨ê³¼ ìš°ìˆ˜. í–¥í›„ ì‚¬ì „ êµìœ¡ ê°•í™” í•„ìš”.
        ë¶™ì„  1. í˜„ì¥ì²´í—˜í•™ìŠµ ì‚¬ì§„ìë£Œ 1ë¶€.
              2. í•™ìƒ ì†Œê°ë¬¸ ëª¨ìŒ 1ë¶€. ë.
        ---
        [ë³´ê³  ë‚´ìš©]
        - í™œë™ëª…: {activity_title}
        - ê´€ë ¨ ê·¼ê±°: {related_basis}
        - í™œë™ ê°œìš”: {activity_overview}
        - ì„¸ë¶€ ë‚´ìš©: {activity_details}
        - ì˜ˆì‚° ì •ë³´: {budget_info}
        - í‰ê°€ ë° ì œì–¸: {evaluation}
        - ë¶™ì„ ë¬¸ì„œ: {attachments}
        ---"""),
    
    # 3-1. êµê³¼í‰ì–´ (êµê³¼ì„¸íŠ¹)
    "student_record": ChatPromptTemplate.from_template("""
        ë‹¹ì‹ ì€ í•™ìƒì˜ ì„±ì¥ê³¼ ì ì¬ë ¥ì„ ê¿°ëš«ì–´ ë³´ëŠ” ëŒ€í•œë¯¼êµ­ ì´ˆÂ·ì¤‘í•™êµì˜ ë² í…Œë‘ êµì‚¬ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì˜ ì—­ëŸ‰ì´ ì…ì²´ì ìœ¼ë¡œ ë“œëŸ¬ë‚˜ëŠ” êµê³¼ì„¸íŠ¹(êµê³¼ë³„ ì„¸ë¶€ëŠ¥ë ¥ ë° íŠ¹ê¸°ì‚¬í•­) ì˜ˆì‹œë¬¸ì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

        [ì‘ì„± ê·œì¹™]
        1.  **ê´€ì°° ê¸°ë°˜ì˜ êµ¬ì²´ì„±**: í•™ìƒì˜ ì‹¤ì œ í™œë™, ë°œì–¸, ê²°ê³¼ë¬¼ì„ ê·¼ê±°ë¡œ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ í•©ë‹ˆë‹¤. ('~ì— ëŒ€í•´ ë°œí‘œí•¨' (X) -> '~ìë£Œë¥¼ ë¶„ì„í•˜ì—¬ ~ë¼ëŠ” ìƒˆë¡œìš´ ê´€ì ì„ ì œì‹œí•œ ë°œí‘œë¡œ ë›°ì–´ë‚œ íƒêµ¬ ì—­ëŸ‰ì„ ë³´ì—¬ì¤Œ' (O))
        2.  **ì—­ëŸ‰ ì¤‘ì‹¬ì˜ ì˜ë¯¸ ë¶€ì–¬**: í•™ìƒì˜ í–‰ë™ì„ 'í•™ì—… ì—­ëŸ‰', 'ì§„ë¡œ ì—­ëŸ‰', 'ê³µë™ì²´ ì—­ëŸ‰'ê³¼ ì—°ê²°í•˜ì—¬ ê¹Šì´ ìˆëŠ” ì˜ë¯¸ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
        3.  **ì„±ì¥ ê³¼ì • ì„œìˆ **: í•™ìƒì´ ì–´ë–¤ ë…¸ë ¥ì„ í†µí•´ ì–´ë–»ê²Œ ì„±ì¥í–ˆëŠ”ì§€ ê³¼ì •ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
        4.  **ë¬¸ì²´**: ê°„ê²°í•˜ê³  ì‚¬ì‹¤ì ì¸ í‰ì–´ì²´(~í•¨, ~ìŒ, ~ë³´ì—¬ì¤Œ, ~ì—­ëŸ‰ì´ ë‹ë³´ì„)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ë¶€ì •ì ì¸ í‘œí˜„ì´ë‚˜ ë¯¸ì‚¬ì—¬êµ¬ëŠ” ì§€ì–‘í•©ë‹ˆë‹¤.
        ---
        [í•™ìƒ ì •ë³´]
        - ê³¼ëª©: {subject}
        - í•µì‹¬ ì—­ëŸ‰ í‚¤ì›Œë“œ: {competency}
        - í•™ìƒ ê´€ì°° ë‚´ìš© (í™œë™, ì§ˆë¬¸, ê²°ê³¼ë¬¼, íƒœë„ ë“±): {observation}
        ---
        ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, í•™ìƒì˜ ì—­ëŸ‰ê³¼ ì„±ì¥ì´ ìƒìƒí•˜ê²Œ ë“œëŸ¬ë‚˜ëŠ” êµê³¼ì„¸íŠ¹ ì˜ˆì‹œë¬¸ì„ 2~3ê°€ì§€ ë²„ì „ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì‹­ì‹œì˜¤."""),

    # 3-2. í–‰ë°œ (í–‰ë™ë°œë‹¬ìƒí™©)
    "behavior_record": ChatPromptTemplate.from_template("""
        ë‹¹ì‹ ì€ í•™ìƒì˜ ì¸ì„±ê³¼ ì„±ì¥ì„ ë©´ë°€íˆ ê´€ì°°í•˜ëŠ” ëŒ€í•œë¯¼êµ­ ì´ˆÂ·ì¤‘í•™êµì˜ ë² í…Œë‘ ë‹´ì„êµì‚¬ì…ë‹ˆë‹¤. ì£¼ì–´ì§„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ í•™ìƒì˜ í–‰ë™ë°œë‹¬ìƒí™©ì´ êµ¬ì²´ì ì´ê³  ê¸ì •ì ìœ¼ë¡œ ë“œëŸ¬ë‚˜ëŠ” ì˜ˆì‹œë¬¸ì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

        [ì‘ì„± ê·œì¹™]
        1.  **êµ¬ì²´ì  í–‰ë™ ê´€ì°°**: í•™ìƒì˜ ì‹¤ì œ í–‰ë™, ë§, íƒœë„ë¥¼ êµ¬ì²´ì ìœ¼ë¡œ ì„œìˆ í•©ë‹ˆë‹¤. ('ì¹œêµ¬ë“¤ê³¼ ì˜ ì§€ëƒ„' (X) -> 'ì–´ë ¤ìš´ ì¹œêµ¬ë¥¼ ë¨¼ì € ë„ì™€ì£¼ê³ , ê°ˆë“± ìƒí™©ì—ì„œ ì¤‘ì¬ ì—­í• ì„ í•˜ë©° ì›ë§Œí•œ í•™ê¸‰ ë¶„ìœ„ê¸° ì¡°ì„±ì— ê¸°ì—¬í•¨' (O))
        2.  **ì„±ì¥ê³¼ ë³€í™” ê°•ì¡°**: í•™ê¸° ì´ˆì™€ ë¹„êµí•˜ì—¬ í•™ìƒì´ ì–´ë–»ê²Œ ì„±ì¥í•˜ê³  ë³€í™”í–ˆëŠ”ì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
        3.  **ê¸ì •ì  í‘œí˜„**: ë¶€ì¡±í•œ ë¶€ë¶„ë„ ì„±ì¥ ê°€ëŠ¥ì„±ê³¼ ë…¸ë ¥í•˜ëŠ” ëª¨ìŠµìœ¼ë¡œ ê¸ì •ì ìœ¼ë¡œ í‘œí˜„í•©ë‹ˆë‹¤.
        4.  **ì¸ì„± ì—­ëŸ‰ ì—°ê²°**: ê´€ì°°ëœ í–‰ë™ì„ 'ì†Œí†µì—­ëŸ‰', 'ê³µë™ì²´ì—­ëŸ‰', 'ìê¸°ê´€ë¦¬ì—­ëŸ‰' ë“±ê³¼ ì—°ê²°í•˜ì—¬ ì˜ë¯¸ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.
        5.  **ë¬¸ì²´**: ë”°ëœ»í•˜ê³  ê²©ë ¤í•˜ëŠ” í‰ì–´ì²´(~í•¨, ~ë³´ì—¬ì¤Œ, ~ë…¸ë ¥í•¨, ~ì„±ì¥í•¨)ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
        ---
        [í•™ìƒ ê´€ì°° ì •ë³´]
        - í•µì‹¬ í–‰ë™ íŠ¹ì„±: {behavior_trait}
        - êµ¬ì²´ì  ê´€ì°° ë‚´ìš© (í–‰ë™, íƒœë„, ë³€í™” ê³¼ì • ë“±): {observation}
        - íŠ¹ë³„íˆ ê°•ì¡°í•˜ê³  ì‹¶ì€ ì„±ì¥ í¬ì¸íŠ¸: {growth_point}
        ---
        ìœ„ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ, í•™ìƒì˜ ì¸ì„±ê³¼ í–‰ë™ë°œë‹¬ì´ ìƒìƒí•˜ê²Œ ë“œëŸ¬ë‚˜ëŠ” í–‰ë°œ ì˜ˆì‹œë¬¸ì„ 2~3ê°€ì§€ ë²„ì „ìœ¼ë¡œ ì‘ì„±í•´ ì£¼ì‹­ì‹œì˜¤."""),

    # 4. í•™ë¶€ëª¨ ë‹µì¥
    "parent_reply": ChatPromptTemplate.from_template("""
        ë‹¹ì‹ ì€ í•™ìƒì„ ê¹Šì´ ì•„ë¼ê³  í•™ë¶€ëª¨ì™€ ì›í™œí•˜ê²Œ ì†Œí†µí•˜ëŠ” ëŒ€í•œë¯¼êµ­ ì´ˆÂ·ì¤‘í•™êµì˜ í˜„ëª…í•˜ê³  ë”°ëœ»í•œ ë‹´ì„ êµì‚¬ì…ë‹ˆë‹¤. í•™ë¶€ëª¨ë‹˜ì´ ë³´ë‚´ì‹  ë©”ì‹œì§€ì— ëŒ€í•´, ê³µê°ê³¼ ì „ë¬¸ì„±ì„ ë°”íƒ•ìœ¼ë¡œ ì •ì¤‘í•˜ê³  ì‹ ë¢°ë¥¼ ì£¼ëŠ” ë‹µì¥ ì´ˆì•ˆì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

        [ì‘ì„± ê·œì¹™]
        1.  **ê³µê°ìœ¼ë¡œ ì‹œì‘**: í•™ë¶€ëª¨ë‹˜ì˜ ê±±ì •ì´ë‚˜ ë§ˆìŒì— ë¨¼ì € ê³µê°í•˜ëŠ” í‘œí˜„ìœ¼ë¡œ ë¬¸ì„ ì—½ë‹ˆë‹¤. ('ì–´ë¨¸ë‹˜ì˜ ì—¼ë ¤í•˜ì‹œëŠ” ë§ˆìŒ, ì¶©ë¶„íˆ ì´í•´ë©ë‹ˆë‹¤.')
        2.  **ê¸ì •ì  ê´€ì°° ì‚¬ì‹¤ ì „ë‹¬**: ìë…€ì— ëŒ€í•œ ê¸ì •ì ì¸ ê´€ì°° ë‚´ìš©ì´ë‚˜ ì¹­ì°¬í•  ì ì„ í•¨ê»˜ ì „ë‹¬í•˜ì—¬ ì•ˆì‹¬ì‹œí‚µë‹ˆë‹¤.
        3.  **êµ¬ì²´ì ì¸ í•´ê²° ë°©ì•ˆ ì œì‹œ**: ë¬¸ì œ ìƒí™©ì— ëŒ€í•´ êµì‚¬ë¡œì„œ í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë…¸ë ¥ê³¼ í•´ê²° ë°©ì•ˆì„ ì œì‹œí•©ë‹ˆë‹¤.
        4.  **í•¨ê»˜ ë…¸ë ¥í•˜ëŠ” ìì„¸**: ê°€ì •ê³¼ì˜ ì—°ê³„ì™€ í˜‘ë ¥ì„ ê°•ì¡°í•˜ë©° í•¨ê»˜ ë…¸ë ¥í•˜ê² ë‹¤ëŠ” ì˜ì§€ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤.
        5.  **ì •ì¤‘í•œ ë§ˆë¬´ë¦¬**: ê°ì‚¬ ì¸ì‚¬ì™€ í•¨ê»˜ ë‹¤ìŒ ì†Œí†µì„ ê¸°ì•½í•˜ë©° ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.
        ---
        [í•™ë¶€ëª¨ë‹˜ ë©”ì‹œì§€]
        {parent_message}

        [ë‹µì¥ ì–´ì¡° ë° í•µì‹¬ ë°©í–¥]
        {tone}
        ---
        ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ í•™ë¶€ëª¨ë‹˜ê»˜ ë³´ë‚¼ ë‹µì¥ ì´ˆì•ˆì„ ì‘ì„±í•´ ì£¼ì‹­ì‹œì˜¤."""),

    # (ì‹ ê·œ) 5. ê°€ì •í†µì‹ ë¬¸
    "newsletter": ChatPromptTemplate.from_template("""
        ë‹¹ì‹ ì€ êµìœ¡ ê²½í—˜ì´ í’ë¶€í•˜ê³  ë¬¸ì¥ë ¥ì´ ë›°ì–´ë‚œ ëŒ€í•œë¯¼êµ­ ì´ˆÂ·ì¤‘í•™êµ êµì‚¬ì…ë‹ˆë‹¤. í•™ë¶€ëª¨ë‹˜ë“¤ì´ ë‚´ìš©ì„ ì‰½ê²Œ ì´í•´í•˜ê³  í˜‘ì¡°í•  ìˆ˜ ìˆë„ë¡, í•µì‹¬ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ê°€ì •í†µì‹ ë¬¸ ì´ˆì•ˆì„ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.

        [ì‘ì„± ê·œì¹™]
        1.  **ì œëª©**: ë‚´ìš©ì„ í•œëˆˆì— ì•Œ ìˆ˜ ìˆëŠ” ì œëª©ì„ ì‘ì„±í•©ë‹ˆë‹¤. (ì˜ˆ: OOO ì•ˆë‚´, OOO ì‹ ì²­ ì•ˆë‚´ ë“±)
        2.  **ì¸ì‚¬ë§**: ê³„ì ˆì´ë‚˜ ì‹œê¸°ì— ë§ëŠ” ë”°ëœ»í•œ ì¸ì‚¬ë§ë¡œ ì‹œì‘í•©ë‹ˆë‹¤.
        3.  **ë³¸ë¬¸**: 'ì–¸ì œ, ì–´ë””ì„œ, ëˆ„ê°€, ë¬´ì—‡ì„, ì™œ, ì–´ë–»ê²Œ' ìœ¡í•˜ì›ì¹™ì— ë”°ë¼ í•µì‹¬ ì •ë³´ë¥¼ ëª…í™•í•˜ê³  ê°„ê²°í•˜ê²Œ ì „ë‹¬í•©ë‹ˆë‹¤. í•„ìš”í•œ ê²½ìš° 'ì•„ë˜' ë˜ëŠ” 'ë‹¤ìŒ'ì„ ì‚¬ìš©í•˜ì—¬ í•­ëª©ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.
        4.  **ê°•ì¡°**: ì¤‘ìš”í•œ ë‚ ì§œë‚˜ ì‹œê°„, ì¤€ë¹„ë¬¼ ë“±ì€ êµµì€ ê¸€ì”¨ë‚˜ ë°‘ì¤„ì„ ì‚¬ìš©í•˜ì—¬ ê°•ì¡°í•©ë‹ˆë‹¤.
        5.  **ë§ºìŒë§**: í•™êµ êµìœ¡ì— ëŒ€í•œ ê´€ì‹¬ê³¼ í˜‘ì¡°ì— ê°ì‚¬í•˜ëŠ” ë§ë¡œ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.
        6.  **ë‚ ì§œ ë° ë°œì‹  ëª…ì˜**: ë¬¸ì„œ í•˜ë‹¨ì— ë°œì†¡ ë‚ ì§œì™€ í•™êµì¥ ì§ì¸ì„ í¬í•¨í•œ ë°œì‹  ëª…ì˜ë¥¼ ê¸°ì¬í•©ë‹ˆë‹¤.
        ---
        [ê°€ì •í†µì‹ ë¬¸ í•µì‹¬ ë‚´ìš©]
        - ì œëª©: {title}
        - ëŒ€ìƒ í•™ë…„: {grade}
        - ì „ë‹¬í•  í•µì‹¬ ë‚´ìš© (ë‚ ì§œ, ì¥ì†Œ, ì¤€ë¹„ë¬¼, ì‹ ì²­ ë°©ë²• ë“±): {main_points}
        - í•™êµëª…: {school_name}
        ---
        ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ, í•™ë¶€ëª¨ë‹˜ë“¤ì´ ì´í•´í•˜ê¸° ì‰¬ìš´ ì¹œì ˆí•˜ê³  ê²©ì‹ ìˆëŠ” ê°€ì •í†µì‹ ë¬¸ ì´ˆì•ˆì„ ì‘ì„±í•´ ì£¼ì‹­ì‹œì˜¤.""")
}

# --- ë©”ì¸ ì•± êµ¬ì„± ---

st.title("ğŸŒ¡ï¸ êµì‹¤ì˜ ì˜¨ë„")
st.markdown("""
<div style="
    background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    border-left: 4px solid #2196F3;
">
    <p style="margin: 0; color: #424242; font-size: 16px; line-height: 1.6;">
        <strong>ì°¨ê°€ìš´ í–‰ì • ì—…ë¬´ë¥¼ ëœì–´ë‚´ê³ , êµì‹¤ì— ë”°ëœ»í•œ ì˜¨ê¸°ë¥¼ ë”í•œë‹¤ëŠ” ëœ»ì„ ë‹´ì•˜ìŠµë‹ˆë‹¤.</strong><br>
        ì„ ìƒë‹˜ì˜ í•˜ë£¨ë¥¼ ê°€ë³ê²Œ ë§Œë“¤ì–´ ì¤„ ìŠ¤ë§ˆíŠ¸ ë™ë£Œì…ë‹ˆë‹¤. ì•„ë˜ íƒ­ì—ì„œ ì›í•˜ì‹œëŠ” ì‘ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
    </p>
</div>
""", unsafe_allow_html=True)

# ê¸°ëŠ¥ íƒ­ ìƒì„±
tab1, tab2, tab3, tab4 = st.tabs(["ğŸ“ ê¸°ì•ˆë¬¸ ì‘ì„±", "ğŸ“š ìƒê¸°ë¶€ ê¸°ë¡", "ğŸ’Œ í•™ë¶€ëª¨ ë‹µì¥", "ğŸ“¢ ê°€ì •í†µì‹ ë¬¸ ì‘ì„±"])

# ê³µí†µ í•¨ìˆ˜: ì²´ì¸ ì‹¤í–‰ ë° ê²°ê³¼ í‘œì‹œ
def run_chain_and_display(chain_key, inputs, container):
    # .env íŒŒì¼ì—ì„œ í‚¤ë¥¼ ìë™ìœ¼ë¡œ ë¡œë“œí•˜ë¯€ë¡œ, í‚¤ í™•ì¸ ë¡œì§ì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤.
    try:
        llm = ChatOpenAI(model="gpt-4o", temperature=0.5) # api_key ì¸ìê°€ ì—†ì–´ë„ ìë™ìœ¼ë¡œ í™˜ê²½ë³€ìˆ˜ì—ì„œ ì°¾ìŠµë‹ˆë‹¤.
        prompt = PROMPTS[chain_key]
        chain = prompt | llm | StrOutputParser()

        with st.spinner("ì´ˆì•ˆì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”."):
            result = chain.invoke(inputs)
            st.session_state.generated_texts[chain_key] = result

        result_text = st.text_area("âœï¸ ìƒì„± ê²°ê³¼", value=st.session_state.generated_texts[chain_key], height=400, key=f"result_{chain_key}")
        
        # JavaScriptë¥¼ ì‚¬ìš©í•œ í´ë¦½ë³´ë“œ ë³µì‚¬
        text_to_copy = st.session_state.generated_texts[chain_key].replace("'", "\\'").replace('"', '\\"').replace('\n', '\\n').replace('\r', '')
        
        copy_button_html = f"""
        <div style="margin: 10px 0;">
            <button onclick="copyToClipboard()" style="
                background-color: #ff6b6b;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 16px;
                width: 100%;
                font-weight: bold;
            ">
                ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬
            </button>
            <div id="copy-message" style="
                display: none;
                color: green;
                font-weight: bold;
                margin-top: 10px;
                text-align: center;
            ">
                âœ… í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
            </div>
        </div>
        <script>
            function copyToClipboard() {{
                const text = `{text_to_copy}`;
                
                if (navigator.clipboard && window.isSecureContext) {{
                    // ìµœì‹  ë¸Œë¼ìš°ì € - Clipboard API ì‚¬ìš©
                    navigator.clipboard.writeText(text).then(function() {{
                        showCopyMessage();
                    }}).catch(function(err) {{
                        fallbackCopy(text);
                    }});
                }} else {{
                    // êµ¬í˜• ë¸Œë¼ìš°ì € - Fallback ë°©ë²•
                    fallbackCopy(text);
                }}
            }}
            
            function fallbackCopy(text) {{
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                
                try {{
                    document.execCommand('copy');
                    showCopyMessage();
                }} catch (err) {{
                    console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                    alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì„ íƒí•˜ì—¬ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
                }}
                
                document.body.removeChild(textArea);
            }}
            
            function showCopyMessage() {{
                const message = document.getElementById('copy-message');
                message.style.display = 'block';
                setTimeout(function() {{
                    message.style.display = 'none';
                }}, 2000);
            }}
        </script>
        """
        
        components.html(copy_button_html, height=100)
    except Exception as e:
        # OPENAI_API_KEYê°€ .envì— ì—†ê±°ë‚˜ ì˜ëª»ëœ ê²½ìš° ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
        st.error(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. .env íŒŒì¼ì˜ OPENAI_API_KEY ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. (ì—ëŸ¬: {e})")




# --- íƒ­ 1: ê¸°ì•ˆ ì‘ì„± ---
with tab1:
    st.header("âœï¸ ê¸°ì•ˆë¬¸ ì‘ì„± ë„ìš°ë¯¸")
    doc_type = st.selectbox(
        "ì‘ì„±í•  ê¸°ì•ˆë¬¸ ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.",
        ("ì„ íƒí•˜ì„¸ìš”", 
         "ë‚´ë¶€ê²°ì¬: ê°ì¢… ê³„íš ìˆ˜ë¦½", "ë‚´ë¶€ê²°ì¬: ì˜ˆì‚° ì§‘í–‰(í’ˆì˜)", 
         "ëŒ€ì™¸ë°œì†¡: ìë£Œ ì œì¶œ", "ë³´ê³ : í™œë™ ê²°ê³¼ ë³´ê³ ")
    )

    if doc_type == "ë‚´ë¶€ê²°ì¬: ê°ì¢… ê³„íš ìˆ˜ë¦½":
        with st.expander("ğŸ—“ï¸ **ê°ì¢… ê³„íš ìˆ˜ë¦½** ì •ë³´ ì…ë ¥", expanded=True):
            st.markdown("ğŸ’¡ **ê°„ë‹¨ ì…ë ¥ ëª¨ë“œ**: í•µì‹¬ ì •ë³´ë§Œ ì…ë ¥í•˜ë©´ ìë™ìœ¼ë¡œ ì™„ì„±í•©ë‹ˆë‹¤!")
            plan_name = st.text_input("1. ê³„íšëª…", placeholder="ì˜ˆ: í˜„ì¥ì²´í—˜í•™ìŠµ")
            simple_content = st.text_area("2. ê°„ë‹¨í•œ ê³„íš ë‚´ìš©", height=120, placeholder="ê°„ë‹¨íˆ ì…ë ¥í•´ì£¼ì„¸ìš”! ì˜ˆ:\nâ€¢ 10ì›” 15ì¼ ë¯¼ì†ì´Œ ê²¬í•™\nâ€¢ 5í•™ë…„ ëŒ€ìƒ\nâ€¢ ì²´í—˜ í™œë™ê³¼ ì—­ì‚¬ í•™ìŠµ")
            
            # ê³ ê¸‰ ì˜µì…˜ (ì„ íƒì‚¬í•­)
            with st.expander("ğŸ”§ ì„¸ë¶€ ì„¤ì • (ì„ íƒì‚¬í•­)", expanded=False):
                related_basis = st.text_input("ê´€ë ¨ ê·¼ê±°", placeholder="ìë™ ì„¤ì •ë¨ (ì˜ˆ: í•™êµêµìœ¡ê³„íš)")
                custom_purpose = st.text_area("ëª©ì  (ì»¤ìŠ¤í…€)", height=80, placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±")
                attachments = st.text_input("ë¶™ì„ ë¬¸ì„œ", placeholder="ë¹„ì›Œë‘ë©´ ê¸°ë³¸ ë¬¸ì„œë¡œ ì„¤ì •")
            
            if st.button("âœ¨ ê³„íšì•ˆ ìƒì„±", use_container_width=True, key="plan"):
                if plan_name and simple_content:
                    # ê¸°ë³¸ê°’ ì„¤ì •
                    final_basis = related_basis if related_basis else "2025í•™ë…„ë„ í•™êµêµìœ¡ê³„íš"
                    final_purpose = custom_purpose if custom_purpose else f"{plan_name}ì„ í†µí•´ í•™ìƒë“¤ì˜ ì²´í—˜ í•™ìŠµ ê¸°íšŒë¥¼ ì œê³µí•˜ê³  êµìœ¡ê³¼ì •ê³¼ ì—°ê³„ëœ ë‹¤ì–‘í•œ ê²½í—˜ì„ í†µí•´ ì„±ì¥í•  ìˆ˜ ìˆë„ë¡ í•¨"
                    final_attachments = attachments if attachments else f"{plan_name} ì„¸ë¶€ ì¼ì • 1ë¶€., ì•ˆì „ ê´€ë¦¬ ê³„íš 1ë¶€."
                    
                    run_chain_and_display("plan", {
                        "plan_name": plan_name, 
                        "related_basis": final_basis, 
                        "purpose": final_purpose, 
                        "details": simple_content, 
                        "attachments": final_attachments
                    }, st)
                else: st.warning("ê³„íšëª…ê³¼ ê³„íš ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

    elif doc_type == "ë‚´ë¶€ê²°ì¬: ì˜ˆì‚° ì§‘í–‰(í’ˆì˜)":
        with st.expander("ğŸ’° **ì˜ˆì‚° ì§‘í–‰(í’ˆì˜)** ì •ë³´ ì…ë ¥", expanded=True):
            st.markdown("ğŸ’¡ **ê°„ë‹¨ ì…ë ¥ ëª¨ë“œ**: êµ¬ì…í•  ë¬¼í’ˆê³¼ ì˜ˆì‚°ë§Œ ì…ë ¥í•˜ì„¸ìš”!")
            purchase_simple = st.text_input("1. êµ¬ì…í•  ë¬¼í’ˆ/ìš©ë„", placeholder="ì˜ˆ: êµì‹¤ìš© í”„ë¦°í„°")
            budget_amount = st.number_input("2. ì˜ˆì‚° (ì›)", min_value=0, step=10000, placeholder="ì˜ˆ: 550000")
            simple_details = st.text_area("3. ê°„ë‹¨í•œ ë‚´ì—­", height=100, placeholder="ì˜ˆ: HP í”„ë¦°í„° 2ëŒ€, A4ìš©ì§€ 10ë°•ìŠ¤")
            
            # ê³ ê¸‰ ì˜µì…˜ (ì„ íƒì‚¬í•­)
            with st.expander("ğŸ”§ ì„¸ë¶€ ì„¤ì • (ì„ íƒì‚¬í•­)", expanded=False):
                related_basis = st.text_input("ê´€ë ¨ ê·¼ê±°", placeholder="ìë™ ì„¤ì •ë¨ (ì˜ˆ: í•™êµíšŒê³„ ì˜ˆì‚°ì„œ)")  
                budget_subject = st.text_input("ì˜ˆì‚° ê³¼ëª©", placeholder="ìë™ ì„¤ì •ë¨ (ì˜ˆ: ì¼ë°˜ìˆ˜ìš©ë¹„)")
                attachments = st.text_input("ë¶™ì„ ë¬¸ì„œ", placeholder="ìë™ ì„¤ì •ë¨ (ì˜ˆ: ê²¬ì ì„œ)")
            
            if st.button("âœ¨ í’ˆì˜ì„œ ìƒì„±", use_container_width=True, key="budget"):
                if purchase_simple and budget_amount > 0:
                    # ê¸°ë³¸ê°’ ì„¤ì •
                    final_title = f"{purchase_simple} êµ¬ì… í’ˆì˜" 
                    final_basis = related_basis if related_basis else "2025í•™ë…„ë„ í•™êµíšŒê³„ ì˜ˆì‚°ì„œ"
                    final_purpose = f"{purchase_simple} êµ¬ì…ì„ í†µí•´ êµìœ¡í™œë™ì„ ì›í™œíˆ ì§€ì›í•˜ê³ ì í•¨"
                    final_details = simple_details if simple_details else f"{purchase_simple} - ìˆ˜ëŸ‰ ë° ìƒì„¸ ë‚´ì—­ì€ ë¶™ì„ ê²¬ì ì„œ ì°¸ì¡°"
                    final_subject = budget_subject if budget_subject else "ì¼ë°˜ìˆ˜ìš©ë¹„"
                    final_attachments = attachments if attachments else "ë¬¼í’ˆ ê²¬ì ì„œ 1ë¶€."
                    
                    run_chain_and_display("budget", {
                        "purchase_title": final_title,
                        "related_basis": final_basis, 
                        "purpose": final_purpose, 
                        "details": final_details, 
                        "budget_amount": budget_amount, 
                        "budget_subject": final_subject, 
                        "attachments": final_attachments
                    }, st)
                else: st.warning("êµ¬ì…í•  ë¬¼í’ˆê³¼ ì˜ˆì‚°ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

    elif doc_type == "ëŒ€ì™¸ë°œì†¡: ìë£Œ ì œì¶œ":
        with st.expander("ğŸ“¤ **ìë£Œ ì œì¶œ (ì‹œí–‰ë¬¸)** ì •ë³´ ì…ë ¥", expanded=True):
            st.markdown("ğŸ’¡ **ê°„ë‹¨ ì…ë ¥ ëª¨ë“œ**: ì œì¶œí•  ìë£Œëª…ë§Œ ì…ë ¥í•˜ì„¸ìš”!")
            submission_simple = st.text_input("1. ì œì¶œí•  ìë£Œ", placeholder="ì˜ˆ: í•™êµí­ë ¥ ì‹¤íƒœì¡°ì‚¬ ê²°ê³¼")
            
            # ê³ ê¸‰ ì˜µì…˜ (ì„ íƒì‚¬í•­)
            with st.expander("ğŸ”§ ì„¸ë¶€ ì„¤ì • (ì„ íƒì‚¬í•­)", expanded=False):
                recipient = st.text_input("ìˆ˜ì‹ ì", placeholder="ìë™ ì„¤ì •ë¨ (ì˜ˆ: êµìœ¡ì§€ì›ì²­)")
                school_name = st.text_input("í•™êµëª…", placeholder="ìë™ ì„¤ì •ë¨ (ì˜ˆ: OOì¤‘í•™êµ)")
                related_document = st.text_input("ê´€ë ¨ ê³µë¬¸", placeholder="ìë™ ì„¤ì •ë¨")
                attachments = st.text_input("ë¶™ì„ ë¬¸ì„œ", placeholder="ìë™ ì„¤ì •ë¨")
            
            if st.button("âœ¨ ì‹œí–‰ë¬¸ ìƒì„±", use_container_width=True, key="submission"):
                if submission_simple:
                    # ê¸°ë³¸ê°’ ì„¤ì •
                    final_recipient = recipient if recipient else "êµìœ¡ì§€ì›ì²­ êµìœ¡ì¥"
                    final_school = school_name if school_name else "OOì¤‘í•™êµ"
                    final_related = related_document if related_document else f"êµìœ¡ì§€ì›ì²­ ê´€ë ¨ë¶€ì„œ-0000 (2025ë…„ ê³µë¬¸)"
                    final_attachments = attachments if attachments else f"{submission_simple} ë³´ê³ ì„œ 1ë¶€., ê´€ë ¨ ìë£Œ 1ë¶€."
                    
                    run_chain_and_display("submission", {
                        "recipient": final_recipient,
                        "school_name": final_school, 
                        "submission_title": submission_simple,
                        "related_document": final_related,
                        "attachments": final_attachments
                    }, st)
                else: st.warning("ì œì¶œí•  ìë£Œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

    elif doc_type == "ë³´ê³ : í™œë™ ê²°ê³¼ ë³´ê³ ":
        with st.expander("ğŸ“‹ **í™œë™ ê²°ê³¼ ë³´ê³ ** ì •ë³´ ì…ë ¥", expanded=True):
            st.markdown("ğŸ’¡ **ê°„ë‹¨ ì…ë ¥ ëª¨ë“œ**: í™œë™ëª…ê³¼ í•µì‹¬ ë‚´ìš©ë§Œ ì…ë ¥í•˜ë©´ ì™„ì„±!")
            activity_title = st.text_input("1. í™œë™ëª…", placeholder="ì˜ˆ: í˜„ì¥ì²´í—˜í•™ìŠµ")
            activity_simple_overview = st.text_area("2. í™œë™ ê°„ë‹¨ ê°œìš”", height=100, placeholder="ì˜ˆ:\nâ€¢ ì¼ì‹œ: 5ì›” 15ì¼(ìˆ˜)\nâ€¢ ì¥ì†Œ: ê²½ì£¼\nâ€¢ ì°¸ê°€: í•™ìƒ 120ëª…, êµì‚¬ 8ëª…")
            
            # ê³ ê¸‰ ì˜µì…˜ (ì„ íƒì‚¬í•­)
            with st.expander("ğŸ”§ ì„¸ë¶€ ì„¤ì • (ì„ íƒì‚¬í•­)", expanded=False):
                related_basis = st.text_input("ê´€ë ¨ ê·¼ê±°", placeholder="ìë™ ì„¤ì •ë¨")
                detailed_activities = st.text_area("ì„¸ë¶€ í™œë™ ë‚´ìš©", height=80, placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±")
                budget_info = st.text_area("ì˜ˆì‚° ì •ë³´", height=80, placeholder="ë¹„ì›Œë‘ë©´ ê¸°ë³¸ í˜•ì‹ìœ¼ë¡œ ìƒì„±")
                evaluation = st.text_area("í‰ê°€ ë° ì œì–¸", height=80, placeholder="ë¹„ì›Œë‘ë©´ ìë™ ìƒì„±")
                attachments = st.text_input("ë¶™ì„ ë¬¸ì„œ", placeholder="ìë™ ì„¤ì •ë¨")
            
            if st.button("âœ¨ ê²°ê³¼ ë³´ê³ ì„œ ìƒì„±", use_container_width=True, key="activity_report"):
                if activity_title and activity_simple_overview:
                    # ê¸°ë³¸ê°’ ì„¤ì •
                    final_related = related_basis if related_basis else f"OOí•™êµ-0000 (2025ë…„ ê³„íšì„œ)"
                    final_details = detailed_activities if detailed_activities else "í™œë™ ì¼ì •ì— ë”°ë¼ ê³„íšëœ í”„ë¡œê·¸ë¨ì„ ìˆœì°¨ì ìœ¼ë¡œ ì§„í–‰í•¨"
                    final_budget = budget_info if budget_info else "ì´ ì˜ˆì‚° ë²”ìœ„ ë‚´ì—ì„œ ì ì ˆíˆ ì§‘í–‰ë¨"
                    final_evaluation = evaluation if evaluation else "í•™ìƒ ì°¸ì—¬ë„ ë° ë§Œì¡±ë„ ë†’ìŒ. êµìœ¡ì  íš¨ê³¼ ìš°ìˆ˜í•¨"
                    final_attachments = attachments if attachments else f"{activity_title} ì‚¬ì§„ìë£Œ 1ë¶€., ì°¸ê°€ì ì†Œê°ë¬¸ 1ë¶€."
                    
                    run_chain_and_display("activity_report", {
                        "activity_title": activity_title,
                        "related_basis": final_related,
                        "activity_overview": activity_simple_overview,
                        "activity_details": final_details,
                        "budget_info": final_budget,
                        "evaluation": final_evaluation,
                        "attachments": final_attachments
                    }, st)
                else: st.warning("í™œë™ëª…ê³¼ í™œë™ ê°œìš”ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# --- íƒ­ 2: ìƒê¸°ë¶€ ê¸°ë¡ ---
with tab2:
    st.header("ğŸ“– ìƒê¸°ë¶€ ê¸°ë¡ ë„ìš°ë¯¸")
    st.markdown("í•™ìƒì˜ í™œë™ì„ êµ¬ì²´ì ìœ¼ë¡œ ì…ë ¥í• ìˆ˜ë¡, í•™ìƒì˜ ì—­ëŸ‰ê³¼ ì„±ì¥ì´ ë‹ë³´ì´ëŠ” ì¢‹ì€ ê²°ê³¼ë¬¼ì´ ë‚˜ì˜µë‹ˆë‹¤.")
    
    # êµê³¼í‰ì–´ì™€ í–‰ë°œ ì„œë¸Œíƒ­ ìƒì„±
    record_tab1, record_tab2 = st.tabs(["ğŸ“š êµê³¼í‰ì–´ (êµê³¼ì„¸íŠ¹)", "ğŸŒ± í–‰ë°œ (í–‰ë™ë°œë‹¬ìƒí™©)"])
    
    # êµê³¼í‰ì–´ ì„œë¸Œíƒ­
    with record_tab1:
        st.markdown("ì—¬ëŸ¬ í•™ìƒì˜ êµê³¼ì„¸íŠ¹ì„ í‘œ í˜•íƒœë¡œ í•œ ë²ˆì— ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
        
        # ê³¼ëª© ë° ì—­ëŸ‰ ì„¤ì •
        with st.container(border=True):
            st.subheader("ğŸ“š ê³¼ëª© ì„¤ì •")
            col1, col2 = st.columns(2)
            with col1:
                subject = st.text_input("ê³¼ëª©", placeholder="ì˜ˆ: í™•ë¥ ê³¼ í†µê³„", key="subject_table")
            with col2:
                competency = st.text_input("í•µì‹¬ ì—­ëŸ‰ í‚¤ì›Œë“œ", placeholder="ì˜ˆ: ë…¼ë¦¬ì  ì‚¬ê³ ë ¥, ë¬¸ì œ í•´ê²° ëŠ¥ë ¥, íƒêµ¬ ì—­ëŸ‰", key="competency_table")
        
        # í•™ìƒ ìˆ˜ ì„¤ì •
        with st.container(border=True):
            st.subheader("ğŸ‘¥ í•™ìƒ ìˆ˜ ì„¤ì •")
            num_students = st.number_input("í•™ìƒ ìˆ˜", min_value=1, max_value=10, value=3, step=1)
        
        # í•™ìƒ ì •ë³´ ì…ë ¥ í‘œ
        if subject and competency:
            with st.container(border=True):
                st.subheader(f"ğŸ“„ {subject} êµê³¼ì„¸íŠ¹ ìƒì„±")
                
                # ì„¸ì…˜ ìƒíƒœì— í•™ìƒ ë°ì´í„° ì´ˆê¸°í™”
                if 'student_data' not in st.session_state or len(st.session_state.student_data) != num_students:
                    st.session_state.student_data = [{"name": f"í•™ìƒ{i+1}", "observation": ""} for i in range(num_students)]
                
                # í‘œ í—¤ë”
                header_cols = st.columns([1, 2, 4, 1])
                with header_cols[0]:
                    st.markdown("**ë²ˆí˜¸**")
                with header_cols[1]:
                    st.markdown("**ì´ë¦„**")
                with header_cols[2]:
                    st.markdown("**í•™ìŠµ ë‚´ìš© (ê´€ì°° ë‚´ìš©)**")
                with header_cols[3]:
                    st.markdown("**ìƒì„¸**")
                
                st.divider()
                
                # í•™ìƒ ë°ì´í„° ì…ë ¥ í–‰
                for i in range(num_students):
                    cols = st.columns([1, 2, 4, 1])
                    
                    with cols[0]:
                        st.markdown(f"**{i+1:02d}**")
                    
                    with cols[1]:
                        st.session_state.student_data[i]["name"] = st.text_input(
                            "ì´ë¦„", 
                            value=st.session_state.student_data[i]["name"],
                            placeholder=f"í•™ìƒ{i+1}",
                            key=f"name_{i}",
                            label_visibility="collapsed"
                        )
                    
                    with cols[2]:
                        st.session_state.student_data[i]["observation"] = st.text_area(
                            "ê´€ì°° ë‚´ìš©",
                            value=st.session_state.student_data[i]["observation"],
                            placeholder=f"{st.session_state.student_data[i]['name']}ì˜ í•™ìŠµ í™œë™, ë°œí‘œ, ì„±ì¥ ëª¨ìŠµ ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ê¸°ë¡í•´ì£¼ì„¸ìš”.",
                            height=100,
                            key=f"obs_{i}",
                            label_visibility="collapsed"
                        )
                    
                    with cols[3]:
                        st.markdown("**600**")
                    
                    if i < num_students - 1:
                        st.markdown("---")
                
                st.divider()
                
                # ì „ì²´ ìƒì„± ë²„íŠ¼
                col_generate = st.columns([3, 1])
                with col_generate[1]:
                    if st.button("âœ¨ ì „ì²´ ìƒì„±", use_container_width=True, key="generate_all"):
                        # ë¹„ì–´ìˆëŠ” ê´€ì°° ë‚´ìš© í™•ì¸
                        empty_observations = [i+1 for i, data in enumerate(st.session_state.student_data) if not data["observation"].strip()]
                        
                        if empty_observations:
                            st.warning(f"{', '.join(map(str, empty_observations))}ë²ˆ í•™ìƒì˜ ê´€ì°° ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")
                        else:
                            # ì „ì²´ í•™ìƒ êµê³¼ì„¸íŠ¹ ìƒì„±
                            st.session_state.generated_table_results = []
                            
                            for i, data in enumerate(st.session_state.student_data):
                                with st.spinner(f"{data['name']} êµê³¼ì„¸íŠ¹ ìƒì„± ì¤‘..."):
                                    try:
                                        llm = ChatOpenAI(model="gpt-4o", temperature=0.5)
                                        prompt = PROMPTS["student_record"]
                                        chain = prompt | llm | StrOutputParser()
                                        
                                        result = chain.invoke({
                                            "subject": subject,
                                            "competency": competency,
                                            "observation": data["observation"]
                                        })
                                        
                                        st.session_state.generated_table_results.append({
                                            "name": data["name"],
                                            "result": result
                                        })
                                    except Exception as e:
                                        st.error(f"{data['name']} êµê³¼ì„¸íŠ¹ ìƒì„± ì‹¤íŒ¨: {e}")
                                        st.session_state.generated_table_results.append({
                                            "name": data["name"],
                                            "result": f"ìƒì„± ì‹¤íŒ¨: {e}"
                                        })
                            
                            st.success("ì „ì²´ í•™ìƒ êµê³¼ì„¸íŠ¹ ìƒì„± ì™„ë£Œ!")
        
        # ê²°ê³¼ í‘œì‹œ
        if 'generated_table_results' in st.session_state and st.session_state.generated_table_results:
            with st.container(border=True):
                st.subheader("ğŸ“„ ìƒì„± ê²°ê³¼")
                
                for i, result_data in enumerate(st.session_state.generated_table_results):
                    with st.expander(f"{i+1:02d}. {result_data['name']} êµê³¼ì„¸íŠ¹", expanded=True):
                        st.text_area(
                            f"{result_data['name']} ê²°ê³¼",
                            value=result_data['result'],
                            height=200,
                            key=f"result_display_{i}",
                            label_visibility="collapsed"
                        )
                
                # ì „ì²´ ê²°ê³¼ ë³µì‚¬ ë²„íŠ¼
                all_results = "\n\n" + "="*50 + "\n\n".join([f"{data['name']} êµê³¼ì„¸íŠ¹:\n{data['result']}" for data in st.session_state.generated_table_results])
                all_text_to_copy = all_results.replace("'", "\\'").replace('"', '\\"').replace('\n', '\\n').replace('\r', '')
                
                all_copy_button_html = f"""
                <div style="margin: 20px 0; text-align: center;">
                    <button onclick="copyAllResults()" style="
                        background-color: #4CAF50;
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 16px;
                        font-weight: bold;
                    ">
                        ğŸ“‹ ì „ì²´ ê²°ê³¼ ë³µì‚¬
                    </button>
                    <div id="copy-all-message" style="
                        display: none;
                        color: green;
                        font-weight: bold;
                        margin-top: 10px;
                    ">
                        âœ… ì „ì²´ ê²°ê³¼ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!
                    </div>
                </div>
                <script>
                    function copyAllResults() {{
                        const text = `{all_text_to_copy}`;
                        
                        if (navigator.clipboard && window.isSecureContext) {{
                            navigator.clipboard.writeText(text).then(function() {{
                                showAllCopyMessage();
                            }}).catch(function(err) {{
                                fallbackCopyAll(text);
                            }});
                        }} else {{
                            fallbackCopyAll(text);
                        }}
                    }}
                    
                    function fallbackCopyAll(text) {{
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {{
                            document.execCommand('copy');
                            showAllCopyMessage();
                        }} catch (err) {{
                            console.error('ë³µì‚¬ ì‹¤íŒ¨:', err);
                            alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }}
                        
                        document.body.removeChild(textArea);
                    }}
                    
                    function showAllCopyMessage() {{
                        const message = document.getElementById('copy-all-message');
                        message.style.display = 'block';
                        setTimeout(function() {{
                            message.style.display = 'none';
                        }}, 3000);
                    }}
                </script>
                """
                
                st.components.v1.html(all_copy_button_html, height=100)
        
        else:
            st.info("â„¹ï¸ ê³¼ëª©ê³¼ í•µì‹¬ ì—­ëŸ‰ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.")
    
    # í–‰ë°œ ì„œë¸Œíƒ­
    with record_tab2:
        st.markdown("í•™ìƒì˜ í–‰ë™ íŠ¹ì„±ê³¼ ì„±ì¥ ê³¼ì •ì„ ì…ë ¥í•˜ë©´, ë”°ëœ»í•˜ê³  ê¸ì •ì ì¸ í–‰ë™ë°œë‹¬ìƒí™©ì„ ìƒì„±í•©ë‹ˆë‹¤.")
        with st.container(border=True):
            behavior_trait = st.text_input("í•µì‹¬ í–‰ë™ íŠ¹ì„±", placeholder="ì˜ˆ: ë°°ë ¤ì‹¬, ë¦¬ë”ì‹­, ì†Œí†µëŠ¥ë ¥, ìê¸°ê´€ë¦¬ì—­ëŸ‰")
            observation_behavior = st.text_area("êµ¬ì²´ì  ê´€ì°° ë‚´ìš©", placeholder="í•™ìƒì˜ ì‹¤ì œ í–‰ë™, ë§, íƒœë„, ë³€í™” ê³¼ì • ë“±ì„ êµ¬ì²´ì ìœ¼ë¡œ ê¸°ë¡í•´ì£¼ì„¸ìš”.\n(ì˜ˆì‹œ) í•™ê¸° ì´ˆ ì†Œê·¹ì ì´ì—ˆë˜ í•™ìƒì´ ëª¨ë‘  í™œë™ì„ í†µí•´ ì ì°¨ ìì‹ ê°ì„ íšë“í•˜ê³ , ì¹œêµ¬ë“¤ê³¼ ì ê·¹ì ìœ¼ë¡œ ì†Œí†µí•˜ë©° í•™ê¸‰ í™œë™ì— ì°¸ì—¬í•˜ëŠ” ëª¨ìŠµì„ ë³´ì—¬ì¤Œ. ì–´ë ¤ìš´ ì¹œêµ¬ë¥¼ ë¨¼ì € ë„ì™€ì£¼ëŠ” ë°°ë ¤ì‹¬ë„ ë‹ë³´ì„.", height=180)
            growth_point = st.text_input("íŠ¹ë³„íˆ ê°•ì¡°í•˜ê³  ì‹¶ì€ ì„±ì¥ í¬ì¸íŠ¸", placeholder="ì˜ˆ: ì†Œí†µëŠ¥ë ¥ í–¥ìƒ, ë¦¬ë”ì‹­ ë°œíœ˜, ìì‹ ê° ì¦ì§„")

            if st.button("âœ¨ í–‰ë°œ ì˜ˆì‹œ ìƒì„±", use_container_width=True, key="behavior_record"):
                if all([behavior_trait, observation_behavior, growth_point]):
                    run_chain_and_display("behavior_record", {"behavior_trait": behavior_trait, "observation": observation_behavior, "growth_point": growth_point}, st)
                else: st.warning("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# --- íƒ­ 3: í•™ë¶€ëª¨ ë‹µì¥ ---
with tab3:
    st.header("âœ‰ï¸ í•™ë¶€ëª¨ ë‹µì¥ ë„ìš°ë¯¸")
    st.markdown("í•™ë¶€ëª¨ë‹˜ì˜ ë©”ì‹œì§€ì™€ ë‹µì¥ì˜ í•µì‹¬ ë°©í–¥ì„ ì…ë ¥í•˜ë©´, ë”°ëœ»í•˜ê³  ì „ë¬¸ì ì¸ ë‹µì¥ ì´ˆì•ˆì„ ë§Œë“¤ì–´ ë“œë¦½ë‹ˆë‹¤.")
    with st.container(border=True):
        parent_message = st.text_area("í•™ë¶€ëª¨ë‹˜ ë©”ì‹œì§€ ì›ë¬¸", placeholder="ì´ê³³ì— í•™ë¶€ëª¨ë‹˜ê»˜ ë°›ì€ ë©”ì‹œì§€ë¥¼ ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ì–´ ì£¼ì„¸ìš”.", height=150)
        tone = st.text_input("ë‹µì¥ ì–´ì¡° ë° í•µì‹¬ ë°©í–¥", placeholder="ì˜ˆ: ë”°ëœ»í•˜ê³  ê³µê°ì ìœ¼ë¡œ, í•´ê²° ë°©ì•ˆ ì¤‘ì‹¬ìœ¼ë¡œ, ê¸ì •ì ì¸ ë©´ì„ ë¶€ê°í•˜ì—¬")

        if st.button("âœ¨ ë‹µì¥ ì´ˆì•ˆ ìƒì„±", use_container_width=True, key="parent_reply"):
            if all([parent_message, tone]):
                run_chain_and_display("parent_reply", {"parent_message": parent_message, "tone": tone}, st)
            else: st.warning("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# --- íƒ­ 4: ê°€ì •í†µì‹ ë¬¸ ì‘ì„± ---
with tab4:
    st.header("ğŸ“¢ ê°€ì •í†µì‹ ë¬¸ ì‘ì„± ë„ìš°ë¯¸")
    st.markdown("í˜„ì¥ì²´í—˜í•™ìŠµ ë“±ì˜ í•µì‹¬ ë‚´ìš©ë§Œ ì…ë ¥í•˜ë©´ ì™„ì„±ëœ ê°€ì •í†µì‹ ë¬¸ì„ ìƒì„±í•©ë‹ˆë‹¤.")
    
    with st.container(border=True):
        main_points = st.text_area(
            "ì „ë‹¬í•  í•µì‹¬ ë‚´ìš©", 
            placeholder="í˜„ì¥ì²´í—˜í•™ìŠµ ê´€ë ¨ í•µì‹¬ ë‚´ìš©ì„ ê°„ë‹¨íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.\n\nì˜ˆì‹œ:\nâ€¢ 10ì›” 15ì¼(ìˆ˜) ë¯¼ì†ì´Œ ê²¬í•™\nâ€¢ 5í•™ë…„ ëŒ€ìƒ, ì°¸ê°€ë¹„ 3ë§Œì›\nâ€¢ 9ì›” 30ì¼ê¹Œì§€ ì‹ ì²­",
            height=150
        )

        if st.button("âœ¨ ê°€ì •í†µì‹ ë¬¸ ìƒì„±", use_container_width=True, key="newsletter"):
            if main_points.strip():
                # ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                run_chain_and_display("newsletter", {
                    "title": "í˜„ì¥ì²´í—˜í•™ìŠµ ì•ˆë‚´", 
                    "grade": "í•´ë‹¹ í•™ë…„", 
                    "main_points": main_points, 
                    "school_name": "OOì´ˆë“±í•™êµ"
                }, st)
            else: 
                st.warning("í•µì‹¬ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.")

# --- í•˜ë‹¨ ì œì‘ì ì •ë³´ ---
st.markdown("---")
st.markdown("""
<div style="
    text-align: center; 
    padding: 15px; 
    margin-top: 30px;
    color: #888888;
    font-size: 14px;
">
    Made by <strong>ì „ì£¼í™”ì •ì´ˆ ë°•ì„±ê´‘</strong>
</div>
""", unsafe_allow_html=True)